#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <pthread.h>
#include "synchro_list.h"
#define TRUE 1
#define FALSE 0
#define NB_ELEMENTS 150
#define NB_LIGNES 100
#define NB_COLONNES 100

TABLEAU_INFOS_FICHIER* fichier = NULL; // tableau dynamique 2D contenant les informations des fichiers ( date + nom )
int dateFichiers[NB_COLONNES*NB_LIGNES]; //tableau temporaire pour stocker les dates 
char *nomFichiers[NB_COLONNES*NB_LIGNES]; //tableau temporaire pour stocker les noms des fichiers
time_t dateFichier = 29052023;  // un exemple de date
char* nomFichier = "test"; // un exemple de nom
int fichierID = 0; // l'id fu fichier correspond à une case du tableau
int changement_dans_les_fichiers=TRUE; 

void sauvegarderDates (int nbr_lignes, int nbr_colonnes)
{
	int k = 0;
	for(int i=0 ; i < nbr_lignes ; i++ ){
			for(int j=0 ; j < nbr_colonnes ; j++ ){
				dateFichiers [k] = fichier->fichiers[i][j].date;
				k=k+1;
		}
	}
    FILE *fichier; 
    fichier = fopen ("datesFichiers.txt", "wb"); 
    fwrite (dateFichiers, sizeof (int) ,NB_ELEMENTS, fichier);
    fclose (fichier);
}

void recupererDates()
{
    FILE *fichier;
    fichier = fopen ("datesFichiers.txt", "rb"); 
    fread (dateFichiers, sizeof (float), NB_ELEMENTS, fichier);
    fclose (fichier);  
}

void sauvegarderNoms(int nbr_lignes, int nbr_colonnes)
{
	char *nomFichier;
	int k = 0;
	for(int i=0 ; i < nbr_lignes ; i++ ){
			for(int j=0 ; j < nbr_colonnes ; j++ ){ 
				nomFichier = fichier->fichiers[i][j].nom;
				nomFichiers[k] = nomFichier;
				
				k=k+1;
		}
	}
    FILE *fichier; 
    fichier = fopen ("nomsFichiers.txt", "wb"); 
    fwrite (nomFichiers, sizeof (int) ,NB_ELEMENTS, fichier);
    fclose (fichier);
}

void recupererNoms()
{
    FILE *fichier;
    fichier = fopen ("nomsFichiers.txt", "rb"); 
    fread (dateFichiers, sizeof (float), NB_ELEMENTS, fichier);
    fclose (fichier);  
}

void synchronisation()
{
	int i = 0;
	
	// chercher la case vide c'est a dire qui ne contient pas les informations d'un fichier
	while(fichier->fichiers[fichierID][i].date != 0  &&  strcmp(fichier->fichiers[fichierID][i].nom , "nom" )!=0 ) 
 	{
		i++;
	}
	printf("Case pour stocker le fichier : %d\n",i);
	fichier->fichiers[fichierID][i].date = dateFichier;
	strcpy(fichier->fichiers[fichierID][i].nom,nomFichier);
	sauvegarderDates (NB_LIGNES,NB_COLONNES);
	sauvegarderNoms (NB_LIGNES,NB_COLONNES);

}

void* serveur_de_production()
{
	if(changement_dans_les_fichiers == TRUE) // s'il y a eu un changement dans les fichiers, on effectue la synchronisation
	{
		synchronisation();
	}
	printf("Nom du fichier : %s\n",fichier->fichiers[fichierID][0].nom); // test d'affichage
	printf("Date du fichier : %d\n",fichier->fichiers[fichierID][0].date); // test d'affichage
}

TABLEAU_INFOS_FICHIER* alloc_matrice(int lig, int col,TABLEAU_INFOS_FICHIER* fichierInfos)
{
	int i = 0,j=0;
	
	fichierInfos = (TABLEAU_INFOS_FICHIER*)malloc(sizeof(TABLEAU_INFOS_FICHIER));
	
	if(fichierInfos == NULL )
	{
		fprintf(stderr,"Echec alloc_matrice_1() pas assez de memoire\n");
		return NULL;
	}
	
	fichierInfos->nombre_lignes = lig;
	fichierInfos->nombre_colonnes = col;
	
	fichierInfos->fichiers = (CARACTERISTIQUES_FICHIER**)malloc(fichierInfos->nombre_lignes*sizeof(CARACTERISTIQUES_FICHIER*));
	for(i=0; i<fichierInfos->nombre_lignes ; i++)
	{
		fichierInfos->fichiers[i] = (CARACTERISTIQUES_FICHIER*)malloc(fichierInfos->nombre_colonnes*sizeof(CARACTERISTIQUES_FICHIER));
		for(j=0; j<fichierInfos->nombre_colonnes ; j++)
		{
			
			fichierInfos->fichiers[i][j].date=0;
			strcpy(fichierInfos->fichiers[i][j].nom,"nom");

		}
	}

	return fichierInfos;
}

void desalloc_matrice(TABLEAU_INFOS_FICHIER** fichierInfos)
{
	int i=0;
	if(*fichierInfos == NULL )
	{
		fprintf(stderr,"Rien à desalloc_matrice() \n");
		return;
	}
	for(i=0; i<(*fichierInfos)->nombre_lignes ; i++)
	{
		free((*fichierInfos)->fichiers[i]);
	}
	free((*fichierInfos)->fichiers);
	free(*fichierInfos);
	*fichierInfos = NULL;
	return;
}

int main(void)
{
	
		recupererDates();
		recupererNoms ();
		
		pthread_t thread_syncho;
		fichier = alloc_matrice(NB_LIGNES,NB_COLONNES,fichier);		
		pthread_create(&thread_syncho,NULL,serveur_de_production,NULL);
		pthread_join(thread_syncho,NULL);	
		
		/* test */	
		for (int i = 0; i < 10; i++) {
                printf ("fichier %d: date %d, nom %s\n", i, dateFichiers [i], nomFichiers[i]);
        }
        /* fin du test*/
        
		desalloc_matrice(&fichier);
		
		return 0;	
}
