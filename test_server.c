#include <stdio.h>
#include <pthread.h>
#include <stdlib.h>	
#include <time.h>		
#include <unistd.h>	
#include "log.h"

pthread_mutex_t m1, m2;
int estDispoProd=0;
int estDispoBack=0;

int mon_rand(int a, int b)
{
	return ( rand()%(b-a) ) + a;
}

void* dispo_serveur_prod()
{
	int a = mon_rand(1,5);
	sleep(a);
	pthread_mutex_lock(&m1);
	estDispoProd=1;
	if(estDispoBack == 1)
	{
			printf("Le serveur de la prodution est indisponible\n");
			main_log(1, "Le serveur de la prodution est indisponible");
	}
	else
	{
			printf("Le serveur de la production est disponible\n");
			main_log(1, "Le serveur de la production est disponible");
	}
	pthread_mutex_unlock(&m2);

}

void* dispo_serveur_back_up()
{
	int a = mon_rand(1,5);
	sleep(a);
	pthread_mutex_lock(&m2);
	estDispoBack=1;
	if(estDispoProd == 1)
	{
			printf("Le serveur de la back up est indisponible\n");
			main_log(1, "Le serveur de la back up est indisponible");
	}
	else
	{
			printf("Le serveur de la back up est disponible\n");
			main_log(1, "Le serveur de la back up est disponible");
	}
	pthread_mutex_unlock(&m1);

}


int main(void)
{
   pthread_t thread_dispo_prod;
   pthread_t thread_dispo_backup;
 
   srand(time(NULL));
   
   pthread_create(&thread_dispo_prod,NULL,dispo_serveur_prod,NULL);
   pthread_create(&thread_dispo_backup,NULL,dispo_serveur_back_up,NULL);
   
   pthread_join(thread_dispo_prod,NULL);
   pthread_join(thread_dispo_backup,NULL);
   
   pthread_mutex_unlock(&m1);
   pthread_mutex_unlock(&m2);

	return 0;
}

