#include <stdio.h>
#include <pthread.h>
#include <stdlib.h>		
#include <time.h>	
#include <string.h>		
#include <unistd.h>		
#include <semaphore.h>
#include "log.h"

/******************************************
 *  VARIABLES PARTAGEES ENTRE LES THREADS
 * ****************************************/

infoLog* donneesModulesLog; // Données liées aux modules
int T_donneesModulesLog=1; // Taille du pointeur donneesModulesLog
FILE * fichierLog; // Fichier contenant toutes les statistiques

int tete_ecriture_log=0; 
sem_t cases_occ_log, cases_lib_log; //nombre de cases occupées et nbr de cases libres

/************************
 *  FONCTION PRINCIPALE
 * **********************/

void createThreadsLog(infoLog* args) {
	pthread_t thread_ecrivain[NB_THREADS_ECRIVAIN_LOG];
	
	sem_init(&cases_occ_log,0,0);
	sem_init(&cases_lib_log,0,T_donneesModulesLog);

	int i;
	
	// On crée les threads écrivains
	for(i=0;i<NB_THREADS_ECRIVAIN_LOG;i++)
		pthread_create(&thread_ecrivain[i],NULL,ecrivainLog,args);
	
	// On attend que les threads écrivains se finissent
	for(i=0;i<NB_THREADS_ECRIVAIN_LOG;i++)
		pthread_join(thread_ecrivain[i],NULL);
				
	free(args);
		
	printf("\n");
}

/************************
 *  CODES DES THREADS
 * **********************/
 
void ecrire_log(infoLog* info_args)
{
    usleep(mon_randLog(100000,1000000)); 
    if (sizeof(info_args->message) < 128) {
        printf("\tAjout du message %s\n",info_args->message); 
                
        donneesModulesLog = (infoLog *) realloc (donneesModulesLog, tete_ecriture_log+1 * sizeof(infoLog));
        
        donneesModulesLog[tete_ecriture_log] = *info_args;
        
        char strModule[80];
        sprintf(strModule, "%d, ", info_args->numModule);
        char strMessage[80];
        sprintf(strMessage, "%s\n", info_args->message);

        fputs(strModule, fichierLog);
        fputs(strMessage, fichierLog);
        
        T_donneesModulesLog++;
        tete_ecriture_log = (tete_ecriture_log + 1) % T_donneesModulesLog; 
    }

	return;
}

void* ecrivainLog(void *args)
{
	infoLog *info_args = args;
	
	sem_wait(&cases_lib_log);

	ecrire_log(info_args);

	sem_post(&cases_occ_log);

	printf("**Le message %s du module %d a fini d'être ajouté...**\n", info_args->message, info_args->numModule);
	
	return NULL;
}

int mon_randLog(int a, int b)
{
	//on suppose que b>a !
	return ( rand()%(b-a) ) + a;
}

int main_log(int numModule, char* message) {
	infoLog* args = (infoLog *) malloc (sizeof(infoLog));
	args->numModule = numModule;
	args->message = message;

	donneesModulesLog = (infoLog *) malloc (T_donneesModulesLog * sizeof(infoLog));
	fichierLog = fopen("log.txt", "a");
	
	createThreadsLog(args);
	return 0;
}
