#include <stdio.h>
#include <pthread.h>
#include <stdlib.h>		
#include <time.h>		
#include <unistd.h>		
#include <semaphore.h>
#include "stat.h"

#define T_TAMPON 2 // nombre de données par module
#define NB_THREADS_LECTEUR	1
#define NB_THREADS_ECRIVAIN	1


/******************************************
 *  VARIABLES PARTAGEES ENTRE LES THREADS
 * ****************************************/
info donneesModules* // Données liées aux modules

int tete_lecture=0, tete_ecriture=0; 
sem_t cases_occ, cases_lib; //nombre de cases occupées et nbr de cases libres

/************************
 *  FONCTION PRINCIPALE
 * **********************/

void createThreadsStat(info* args) {
	pthread_t thread_lecteur[NB_THREADS_LECTEUR];
	pthread_t thread_ecrivain[NB_THREADS_ECRIVAIN];

	sem_init(&cases_occ,0,0);
	sem_init(&cases_lib,0,T_TAMPON);

	int i;
	
	// On crée les threads écrivains
	for(i=0;i<NB_THREADS_ECRIVAIN;i++)
		pthread_create(&thread_ecrivain[i],NULL,ecrivain,args);
	
	// On crée les threads lecteurs
	for(i=0;i<NB_THREADS_LECTEUR;i++)
		pthread_create(&thread_lecteur[i],NULL,lecteur,args);
	
	// On attend que les threads écrivains se finissent
	for(i=0;i<NB_THREADS_ECRIVAIN;i++)
		pthread_join(thread_ecrivain[i],NULL);
	
	// On attend que les threads lecteurs se finissent
	for(i=0;i<NB_THREADS_LECTEUR;i++)
		pthread_join(thread_lecteur[i],NULL);
		
	free(args);
		
	printf("\n");
}

/************************
 *  CODES DES THREADS
 * **********************/
 
int lire_tampon(int numModule)
{
	int num;

	usleep(mon_rand(100000,1000000)); 
	
	switch(numModule) {
		case 0:
			// ajouter au fichier module 0
			break;
		case 1:
			// ajouter au fichier module 1
			break;
		case 2:
			// ajouter au fichier module 2
			break;
		case 3:
			// ajouter au fichier module 3
			break;
	}
	
	printf("Je lis le %d\n",num); 
	tete_lecture = (tete_lecture + 1) % T_TAMPON;

	return num;
}

void* lecteur(void *args)
{
	int num;

	info *info_args = args;
	
	for (int i=0; i<2; i++) {
		sem_wait(&cases_occ);

		num=lire_tampon(info_args->numModule);

		sem_post(&cases_lib);
	}

	printf("**Lecteur termine...**\n");
	return NULL;
}


void ecrire_tampon(int numModule, int num)
{
    usleep(mon_rand(100000,1000000)); 
	printf("\tJ ecris le %d\n",num); 
	
	switch(numModule) {
		case 0:
			donneesModule0[tete_ecriture] = num;
			break;
		case 1:
			donneesModule1[tete_ecriture] = num;
			break;
		case 2:
			donneesModule2[tete_ecriture] = num;
			break;
		case 3:
			donneesModule3[tete_ecriture] = num;
			break;
	}
		
	printf("h %d\n", tete_ecriture);
	
	tete_ecriture = (tete_ecriture + 1) % T_TAMPON; 
	
    printf("d %d\n", tete_ecriture);
	
	return;
}

void* ecrivain(void *args)
{
	info *info_args = args;
	
	int pos=0;
	
	for(int i=0; i<2; i++)
	{
		sem_wait(&cases_lib);

		ecrire_tampon(info_args->numModule, info_args->information[pos]);

		sem_post(&cases_occ);
		pos++;
	}

	printf("**Ecrivain termine...**\n");
	//free(info_args);
	
	return NULL;
}

int mon_rand(int a, int b)
{
	//on suppose que b>a !
	return ( rand()%(b-a) ) + a;
}

int main(void)
{
	// Exemple
	info* args;
	args->numModule = 0;
	args->nomInformation = "nombreFichiersRecus";
	args->information = 20;

	createThreadsStat(args);
	return 0;
}
