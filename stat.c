#include <stdio.h>
#include <pthread.h>
#include <stdlib.h>		
#include <time.h>	
#include <string.h>		
#include <unistd.h>		
#include <semaphore.h>
#include "stat.h"

/******************************************
 *  VARIABLES PARTAGEES ENTRE LES THREADS
 * ****************************************/

infoStat* donneesModulesStat; // Données liées aux modules
int T_donneesModulesStat=1; // Taille du pointeur donneesModulesStat
FILE * fichierStats; // Fichier contenant toutes les statistiques

int tete_ecriture_stat=0; 
sem_t cases_occ_stat, cases_lib_stat; //nombre de cases occupées et nbr de cases libres

/************************
 *  FONCTION PRINCIPALE
 * **********************/

void createThreadsStat(infoStat* args) {
	pthread_t thread_ecrivain[NB_THREADS_ECRIVAIN_STAT];
	
	sem_init(&cases_occ_stat,0,0);
	sem_init(&cases_lib_stat,0,T_donneesModulesStat);

	int i;
	
	// On crée les threads écrivains
	for(i=0;i<NB_THREADS_ECRIVAIN_STAT;i++)
		pthread_create(&thread_ecrivain[i],NULL,ecrivainStat,args);
	
	// On attend que les threads écrivains se finissent
	for(i=0;i<NB_THREADS_ECRIVAIN_STAT;i++)
		pthread_join(thread_ecrivain[i],NULL);
				
	free(args);
		
	printf("\n");
}

/************************
 *  CODES DES THREADS
 * **********************/
 
void ecrire_stat(infoStat* info_args)
{
    usleep(mon_randSTat(100000,1000000)); 
	printf("\tAjout de l'information %s : %d\n",info_args->nomInformation, info_args->information); 
			
	T_donneesModulesStat++;
	
	donneesModulesStat = (infoStat *) realloc (donneesModulesStat, T_donneesModulesStat * sizeof(infoStat));
	
	donneesModulesStat[tete_ecriture_stat] = *info_args;
	
	char strModule[80];
	sprintf(strModule, "%d, ", info_args->numModule);
	char strNomInformation[80];
	strcat(strNomInformation, info_args->nomInformation);
	strcat(strNomInformation, ", ");
	char strInformation[80];
	sprintf(strInformation, "%d\n", info_args->information);

	fputs(strModule, fichierStats);
	fputs(strNomInformation, fichierStats);
	fputs(strInformation, fichierStats);
	
	tete_ecriture_stat = (tete_ecriture_stat + 1) % T_donneesModulesStat; 

	return;
}

void* ecrivainStat(void *args)
{
	infoStat *info_args = args;
	
	sem_wait(&cases_lib_stat);

	ecrire_stat(info_args);

	sem_post(&cases_occ_stat);

	printf("**Module n%d a fini d'ajouter ses stats...**\n", info_args->numModule);
	
	return NULL;
}

int mon_randSTat(int a, int b)
{
	//on suppose que b>a !
	return ( rand()%(b-a) ) + a;
}

int main_stat(int numModule, char* nomInformation, int information)
{
	infoStat* args = (infoStat *) malloc (sizeof(infoStat));
	args->numModule = numModule;
	args->nomInformation = nomInformation;
	args->information = information;

	donneesModulesStat = (infoStat *) malloc (T_donneesModulesStat * sizeof(infoStat));
	fichierStats = fopen("statistiques.txt", "a");
	
	createThreadsStat(args);
	return 0;
}
