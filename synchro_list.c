#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <pthread.h>
#include "synchro_list.h"
#include "stat.h"
#include "log.h"

int nbr_fichier_ajoutes=0;

int recuperer_infos_module_syncho()
{
	nbr_fichier_ajoutes++;
	return nbr_fichier_ajoutes;
}

Liste *creer_liste()
{
    Liste *liste = malloc(sizeof(*liste));
    Element *element = malloc(sizeof(*element));

    liste->taille = 0;
    element->suivant = NULL;
    liste->premier = element;
    return liste;
}

void ajouter_nouveau_element_liste (Liste* liste, CARACTERISTIQUES_FICHIER fichier)
{
	Element* nouveau = (Element*)malloc(sizeof(Element));
	
	nouveau->fichier = fichier;
	nouveau->suivant = liste->premier;
	
	liste->premier = nouveau;
	liste->taille++;
	nbr_fichier_ajoutes = recuperer_infos_module_syncho();
	main_stat(0, "nbrFichiersRecus", nbr_fichier_ajoutes);
	//printf("%d\n",nbr_fichier_ajoutes);
}

void supprimer_element(Liste* liste, int position)
{
    Element* element = liste->premier;
	int fin_liste = 0;
	
    if(position == 0)
    {
        liste->premier = liste->premier->suivant;
        liste->taille = liste->taille - 1;
    }
    else
    {
        for(int i = 0; i < position - 1; i++)
        {

            if(element->suivant == NULL) 
            {
                fin_liste = 1;
                break;
            }
            else
            {
                element = element->suivant;
            }
        }

        if(fin_liste)
        {
            printf("erreur : element hors liste");
			main_log(0, "erreur : element hors liste");
        }
        else
        {
            element->suivant =element->suivant->suivant ;
            liste->taille = liste->taille - 1;
        }
    }
}

void afficherListe(Liste *liste)
{
    if (liste == NULL)
    {
        exit(EXIT_FAILURE);
    }

    Element *actuel = liste->premier;
    
	FILE *fichierServeurProd; 
	FILE *fichierServeurBack; 
	fichierServeurProd = fopen ("serveurProductionSynchro.txt", "wb"); 
	fichierServeurBack = fopen ("serveurBackSynchro.txt", "wb"); 
    while (actuel != NULL)
    {
        fprintf(fichierServeurProd,"%s | %s -> ",actuel->fichier.nom, asctime(&actuel->fichier.date));
		fprintf(fichierServeurBack,"%s | %s -> ",actuel->fichier.nom, asctime(&actuel->fichier.date));
        actuel = actuel->suivant;
    }
     fclose (fichierServeurProd);
     fclose(fichierServeurBack);
    printf("\n");
}



void *synchroniser()
{
	Liste  *listeDesFichiers = creer_liste(); 
	CARACTERISTIQUES_FICHIER file; 
	char nomFichier[20];
	int choix=0;
	int supp;
	int nbr=0;
	printf("1/ Ajout d'un fichier\n2/Suppression d'un fichier\n3/Quitter\n");
	
	do{
		printf("Choix: ");
		scanf("%d",&choix);
		if(choix == 1){
			printf("Donnez un nom de votre fichier (indice %d): ",nbr);
			scanf("%s",nomFichier);
			strcpy(file.nom,nomFichier);
			ajouter_nouveau_element_liste (listeDesFichiers, file);   
			printf("Liste synchronisée.\n");
			nbr++;
		}
		else if (choix == 2)
		{
			printf("Donnez l'indice du fichier à supprimer: ");
			scanf("%d",&supp);
			supprimer_element(listeDesFichiers, supp);
			printf("Liste synchronisée.\n");
		}
		afficherListe(listeDesFichiers);
    }while(choix != 3);
    
    return NULL;
	
}

void main_synchro()
{
    pthread_t thread_synchro;
    pthread_create(&thread_synchro,NULL,synchroniser,NULL);
    pthread_join(thread_synchro,NULL);
	
}

int main(void)
{
   
    main_synchro();
	return 0;
}
