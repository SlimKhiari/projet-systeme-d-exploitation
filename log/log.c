#include <stdio.h>
#include <pthread.h>
#include <stdlib.h>		
#include <time.h>	
#include <string.h>		
#include <unistd.h>		
#include <semaphore.h>
#include "log.h"

#define NB_THREADS_ECRIVAIN	1

/******************************************
 *  VARIABLES PARTAGEES ENTRE LES THREADS
 * ****************************************/

info* donneesModules; // Données liées aux modules
int T_donneesModules=1; // Taille du pointeur donneesModules
FILE * fichierLog; // Fichier contenant toutes les statistiques

int tete_ecriture=0; 
sem_t cases_occ, cases_lib; //nombre de cases occupées et nbr de cases libres

/************************
 *  FONCTION PRINCIPALE
 * **********************/

void createThreadsLog(info* args) {
	donneesModules = (info *) malloc (sizeof(info));
	fichierLog = fopen("log.txt", "a");
	
	pthread_t thread_ecrivain[NB_THREADS_ECRIVAIN];
	
	sem_init(&cases_occ,0,0);
	sem_init(&cases_lib,0,T_donneesModules);

	int i;
	
	// On crée les threads écrivains
	for(i=0;i<NB_THREADS_ECRIVAIN;i++)
		pthread_create(&thread_ecrivain[i],NULL,ecrivain,args);
	
	// On attend que les threads écrivains se finissent
	for(i=0;i<NB_THREADS_ECRIVAIN;i++)
		pthread_join(thread_ecrivain[i],NULL);
				
	free(args);
		
	printf("\n");
}

/************************
 *  CODES DES THREADS
 * **********************/
 
void ecrire_log(info* info_args)
{
    usleep(mon_rand(100000,1000000)); 
    if (sizeof(info_args->message) < 128) {
        printf("\tAjout du message %s\n",info_args->message); 
                
        donneesModules = (info *) realloc (donneesModules, tete_ecriture+1 * sizeof(info));
        
        donneesModules[tete_ecriture] = *info_args;
        
        char strModule[80];
        sprintf(strModule, "%d, ", info_args->numModule);
        char strMessage[80];
        sprintf(strInformation, "%s\n", info_args->message);

        fputs(strModule, fichierLog);
        fputs(strNomInformation, fichierStats);
        
        T_donneesModules++;
        tete_ecriture = (tete_ecriture + 1) % T_donneesModules; 
    }

	return NULL;
}

void* ecrivain(void *args)
{
	info *info_args = args;
	
	sem_wait(&cases_lib);

	ecrire_stat(info_args);

	sem_post(&cases_occ);

	printf("**Le message %s du module %d a fini d'être ajouté...**\n", info_args->message, info_args->numModule);
	
	return NULL;
}

int mon_rand(int a, int b)
{
	//on suppose que b>a !
	return ( rand()%(b-a) ) + a;
}

int main(void)
{
	// Exemple
	info* args = (info *) malloc (sizeof(info));
	args->numModule = 0;
	args->nomInformation = "nombreFichiersRecus";
	args->information = 20;

	createThreadsLog(args);
	return 0;
}